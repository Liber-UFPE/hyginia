version: 2.1

orbs:
  # https://circleci.com/developer/orbs/orb/idanelh/ktlint
  ktlint: idanelh/ktlint@1.0.1

jobs:
  ktlint:
    docker:
      - image: cimg/openjdk:21.0.2-browsers
    steps:
      - checkout
      - ktlint/install:
          version: 1.1.1
      - ktlint/lint:
          working-directory: ~/project

  detekt:
    docker:
      - image: cimg/openjdk:21.0-browsers
    environment:
      DETEKT_VERSION: "1.23.3"
    steps:
      - checkout
      - run:
          name: Install Detekt
          # language="shell script"
          command: |
            curl -sSLO "https://github.com/detekt/detekt/releases/download/v$DETEKT_VERSION/detekt-cli-$DETEKT_VERSION.zip"
            unzip "detekt-cli-$DETEKT_VERSION.zip"
            chmod +x "./detekt-cli-$DETEKT_VERSION/bin/detekt-cli"
            ./detekt-cli-$DETEKT_VERSION/bin/detekt-cli --report md:build/reports/detekt/detekt.md

  compile:
    docker:
      - image: cimg/openjdk:21.0.2-browsers
    steps:
      - checkout

      - run:
          name: Generate Gradle Cache Key
          command: md5sum **/*.kts gradle.properties gradle/wrapper/gradle-wrapper.properties package-lock.json > /tmp/deps-cache-key

      - restore_cache:
          keys:
            - v1-deps-{{ checksum "/tmp/deps-cache-key" }}
            - v1-deps-

      - run:
          name: Compile App & Tests
          command: ./gradlew testClasses

      - save_cache:
          key: v1-deps-{{ checksum "/tmp/deps-cache-key" }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper
            - node_modules

  test:
    docker:
      - image: cimg/openjdk:21.0.2-browsers
    steps:
      - checkout
      - run: ./gradlew check

workflows:
  build_and_test:
    jobs:
      - ktlint
      - detekt
      - compile:
          requires:
            - ktlint
            - detekt
      - test:
          requires:
            - compile